trigger:
  branches:
    include:
      - development
  paths:
    include:
      - server/open-weather

variables:
  major: "1"
  minor: "0"
  patch: "0"
  root: "server/open-weather"
  buildConfiguration: "Release"
  publishDirectory: "$(Build.ArtifactStagingDirectory)/publish"

stages:
  - stage: Set_version
    jobs:
      - job: SetVersionJob
        pool: Proxmox agent
        steps:
          - bash: |
              ##vso[task.setvariable variable=fullVersion]$(major).$(minor).$(patch)-$(Build.SourceBranchName).$(Build.BuildNumber)
              echo "$(fullVersion)"
            displayName: "Set Full Version Number"

  - stage: Build_and_package_REST_server
    dependsOn: Set_version
    jobs:
      - job: BuildJob
        pool: Proxmox agent
        steps:
          - task: DotNetCoreCLI@2
            displayName: Restore dependencies
            inputs:
              command: "restore"
              projects: "$(root)/OpenWeather.Adapters.REST/OpenWeather.Adapters.REST.csproj"
              arguments: "--force"         
          - task: DotNetCoreCLI@2
            displayName: Build new publication artefact
            inputs:
              command: "publish"
              projects: "$(root)/OpenWeather.Adapters.REST/OpenWeather.Adapters.REST.csproj"
              arguments: "--configuration $(buildConfiguration) --output $(publishDirectory) --no-restore"
          - task: PublishBuildArtifacts@1
            displayName: Publish artefact
            inputs:
              PathtoPublish: "$(publishDirectory)"
              ArtifactName: "Server-$(fullVersion)"
              publishLocation: "Container"
